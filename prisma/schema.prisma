// Prisma schema for Clear Mind App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum JobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum EntryType {
  TEXT
  AUDIO
}

enum TranscriptionStatus {
  UPLOADED
  QUEUED
  PROCESSING
  DONE
  ERROR
}

model User {
  id             String         @id @default(cuid())
  email          String?        @unique
  phone          String?        @unique
  name           String?
  passwordHash   String
  role           Role           @default(USER)
  emailVerified  DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  profile        Profile?
  journalEntries JournalEntry[]
}

model Profile {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName  String?
  birthDate DateTime?
  city      String?
  phone     String?
  locale    String?
  avatarUrl String?
  gender    Gender?   @default(UNKNOWN)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model AudioAsset {
  id             String         @id @default(cuid())
  userId         String
  bucket         String
  path           String
  mime           String
  size           Int
  duration       Int?
  createdAt      DateTime       @default(now())
  journalEntries JournalEntry[]
}

model JournalEntry {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              EntryType
  title             String?
  text              String?            @db.Text
  summary           String?            @db.Text
  mood              String?
  energy            Int?
  tags              String[]           @default([])
  audioId           String?
  audio             AudioAsset?        @relation(fields: [audioId], references: [id], onDelete: SetNull)
  transcribedAt     DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  jobs              Job[]
  transcriptionJobs TranscriptionJob[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([tags], type: Gin, map: "journal_entries_tags_idx")
}

model Job {
  id        String       @id @default(cuid())
  type      String
  status    JobStatus    @default(PENDING)
  payload   Json
  entryId   String
  entry     JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TranscriptionJob {
  id         String       @id @default(cuid())
  entryId    String
  entry      JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  status     String       @default("PENDING") // PENDING, RUNNING, DONE, ERROR
  provider   String       @default("openai")
  attempts   Int          @default(0)
  error      String?      @db.Text
  createdAt  DateTime     @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([status, createdAt])
  @@index([entryId])
}
