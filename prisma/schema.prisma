// Prisma schema for Clear Mind App

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
  BUSINESS_OWNER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  UNKNOWN
}

enum JobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum EntryType {
  TEXT
  AUDIO
}

enum TranscriptionStatus {
  UPLOADED
  QUEUED
  PROCESSING
  DONE
  ERROR
}

model User {
  id             String         @id @default(cuid())
  email          String?        @unique
  phone          String?        @unique
  name           String?
  passwordHash   String
  role           Role           @default(USER)
  emailVerified  DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  profile        Profile?
  journalEntries JournalEntry[]
  photos         PhotoAsset[]
  businessAccount BusinessAccount?
}

model Profile {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName  String?
  birthDate DateTime?
  city      String?
  phone     String?
  locale    String?
  avatarUrl String?
  gender    Gender?   @default(UNKNOWN)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model AudioAsset {
  id             String         @id @default(cuid())
  userId         String
  bucket         String
  path           String
  mime           String
  size           Int
  duration       Int?
  createdAt      DateTime       @default(now())
  journalEntries JournalEntry[]
}

model JournalEntry {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          EntryType
  title         String?
  text          String?     @db.Text
  summary       String?     @db.Text
  mood          String?
  energy        Int?
  tags          String[]    @default([])
  audioId       String?
  audio         AudioAsset? @relation(fields: [audioId], references: [id], onDelete: SetNull)
  transcribedAt DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  jobs          Job[]
  transcriptionJobs TranscriptionJob[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([tags], type: Gin, map: "journal_entries_tags_idx")
}

model Job {
  id        String       @id @default(cuid())
  type      String
  status    JobStatus    @default(PENDING)
  payload   Json
  entryId   String
  entry     JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model TranscriptionJob {
  id         String   @id @default(cuid())
  entryId    String
  entry      JournalEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)
  status     String   @default("PENDING") // PENDING, RUNNING, DONE, ERROR
  provider   String   @default("openai")
  attempts   Int      @default(0)
  error      String?  @db.Text
  createdAt  DateTime @default(now())
  startedAt  DateTime?
  finishedAt DateTime?

  @@index([status, createdAt])
  @@index([entryId])
}

model ApiKey {
  id         String   @id @default(cuid())
  name       String   // Display name (e.g., "OpenAI Production", "OpenAI Staging")
  provider   String   // Provider name (e.g., "openai", "anthropic")
  keyValue   String   @db.Text // Encrypted key value
  isActive   Boolean  @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String   // User ID who created it

  @@index([provider])
  @@index([isActive])
  @@index([provider, isActive])
}

model PhotoAsset {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bucket    String
  path      String
  mime      String
  size      Int
  width     Int?
  height    Int?
  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
}

enum ServicePricingUnit {
  PER_SERVICE
  PER_ITEM
  PER_HOUR
}

model City {
  id        String   @id @default(cuid())
  code      String   @unique // internal code: SPB, MSK
  nameRu    String
  nameEn    String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  places Place[]

  @@index([code])
}

model BusinessAccount {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  places Place[]
}

model Place {
  id          String   @id @default(cuid())
  businessId String
  business    BusinessAccount @relation(fields: [businessId], references: [id], onDelete: Cascade)
  cityId      String
  city        City     @relation(fields: [cityId], references: [id], onDelete: Restrict)
  name        String
  address     String?
  status      String   @default("pending") // pending, approved, published
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services PlaceService[]

  @@index([businessId])
  @@index([cityId])
}

model ServiceCategory {
  id        String   @id @default(cuid())
  code      String   @unique // internal code: BEAUTY, DRY_CLEANING, KEYS_SHOES
  nameRu    String
  nameEn    String
  icon      String?  // название иконки, например "scissors", "tshirt"
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serviceTypes ServiceType[]

  @@index([code])
  @@index([sortOrder])
}

model ServiceType {
  id          String             @id @default(cuid())
  categoryId  String
  category    ServiceCategory    @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  code        String             @unique // internal: female_haircut, dry_cleaning_coat
  nameRu      String
  nameEn      String
  shortDescription String?       @db.Text

  defaultDurationMinutes Int?
  pricingUnit ServicePricingUnit @default(PER_SERVICE)
  isActive    Boolean            @default(true)

  placeServices PlaceService[]

  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([categoryId])
  @@index([code])
  @@index([isActive])
}

model PlaceService {
  id            String       @id @default(cuid())
  placeId       String
  place         Place        @relation(fields: [placeId], references: [id], onDelete: Cascade)

  serviceTypeId String
  serviceType   ServiceType  @relation(fields: [serviceTypeId], references: [id], onDelete: Restrict)

  priceFrom     Decimal?     @db.Decimal(10, 2)
  priceTo       Decimal?     @db.Decimal(10, 2)
  currency      String       @default("RUB")

  durationMinutes Int?

  isActive      Boolean      @default(true)
  isSpecialOffer Boolean     @default(false)
  specialLabel  String?
  notes         String?      @db.Text

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([placeId])
  @@index([serviceTypeId])
  @@index([isActive])
  @@unique([placeId, serviceTypeId])
}
